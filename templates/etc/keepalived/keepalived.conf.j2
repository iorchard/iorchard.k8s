vrrp_script check_apiserver {
  script "/usr/bin/nc -w1 -z {{ kube_apiserver_advertise_address }} {{ kube_apiserver_bind_port }}"  # check kube-apiserver tcp port is opened
  interval 3  # check every 3 seconds
  timeout 1  # seconds after which script is considered to have failed
  fall 3  # require 3 failures for KO
  rise 3  # require 3 succeses for OK
}

vrrp_instance VI_1 {
  state {{ (inventory_hostname == groups['kube_masters'][0]) | ternary('MASTER', 'BACKUP') }}
  interface {{ keepalived_interface }}
  virtual_router_id 1
  priority {{ (inventory_hostname == groups['kube_masters'][0]) | ternary('100', '50') }}
  advert_int 1
  nopreempt
  virtual_ipaddress {
    {{ keepalived_vip }}
  }
  track_script {
    check_apiserver
  }
}
